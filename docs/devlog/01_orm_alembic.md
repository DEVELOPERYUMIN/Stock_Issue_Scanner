

## ğŸ” ëª¨ë¸ ì‘ì„± â†’ ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„± â†’ DB ë°˜ì˜

ì´ í”„ë¡œì íŠ¸ì—ì„œ DB êµ¬ì¡°ë¥¼ ë‹¤ë£¨ëŠ” ê¸°ë³¸ íë¦„ì€ ì•„ë˜ì™€ ê°™ë‹¤.

1. ORM ëª¨ë¸ì„ íŒŒì´ì¬ ì½”ë“œë¡œ ì‘ì„±í•œë‹¤
2. Alembicìœ¼ë¡œ DB êµ¬ì¡° ë³€ê²½ ì´ë ¥ì„ ìƒì„±í•œë‹¤
3. ìƒì„±ëœ ì´ë ¥ì„ ì‹¤ì œ DBì— ì ìš©í•œë‹¤

---

## 1ï¸âƒ£ ORM (SQLAlchemy)

* ORMì€ **íŒŒì´ì¬ í´ë˜ìŠ¤ â†” DB í…Œì´ë¸”**ì„ ì—°ê²°í•˜ëŠ” ë„êµ¬ë‹¤.
* SQLì„ ì§ì ‘ ì‘ì„±í•˜ì§€ ì•Šê³ ,
  **íŒŒì´ì¬ ì½”ë“œë¡œ í…Œì´ë¸” êµ¬ì¡°ë¥¼ ì •ì˜**í•  ìˆ˜ ìˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´:

* íŒŒì´ì¬ í´ë˜ìŠ¤ `ThemeUniverse`ë¥¼ ì‘ì„±í•˜ë©´
* Alembic ë§ˆì´ê·¸ë ˆì´ì…˜ì„ í†µí•´
* DBì— `theme_universe` í…Œì´ë¸”ì´ ìƒì„±ëœë‹¤.

ì¦‰,

> **DB êµ¬ì¡°ë¥¼ ì½”ë“œë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ê³„ì¸µ**

ì´ë‹¤.

---

## 2ï¸âƒ£ ë§ˆì´ê·¸ë ˆì´ì…˜ (Alembic)

Alembicì€ ë‹¤ìŒ ì—­í• ì„ í•œë‹¤.

> **í˜„ì¬ DB ìƒíƒœ**ì™€
> **ì½”ë“œë¡œ ì •ì˜ëœ DB êµ¬ì¡°(Base.metadata)**ë¥¼ ë¹„êµí•˜ì—¬
> ê·¸ ì°¨ì´ë¥¼ â€œDB ë³€ê²½ ì´ë ¥â€ìœ¼ë¡œ ë§Œë“¤ì–´ì¤€ë‹¤.

---

### Alembicì´ ê´€ë¦¬í•˜ëŠ” ê²ƒ

* í…Œì´ë¸” ìƒì„±
* ì»¬ëŸ¼ ì¶”ê°€ / ì‚­ì œ
* ì¸ë±ìŠ¤ ì¶”ê°€
* íƒ€ì… ë³€ê²½ ë“±

ì´ ëª¨ë“  DB êµ¬ì¡° ë³€ê²½ì„
**íŒŒì¼ ë‹¨ìœ„ì˜ ì´ë ¥(revision)**ìœ¼ë¡œ ê´€ë¦¬í•œë‹¤.

ì˜ˆì‹œ:

* v1: `theme_universe` í…Œì´ë¸” ìƒì„±
* v2: ì»¬ëŸ¼ ì¶”ê°€
* v3: ì¸ë±ìŠ¤ ì¶”ê°€

---

### Alembic ì´ˆê¸°í™”

```bash
alembic init backend/db/migrations
```

ì´ ëª…ë ¹ì„ ì‹¤í–‰í•˜ë©´ ì•„ë˜ êµ¬ì¡°ê°€ ìƒì„±ëœë‹¤.

* `alembic.ini`
  â†’ Alembic ì„¤ì • íŒŒì¼

* `backend/db/migrations/`

  * `env.py`
    â†’ **ê°€ì¥ ì¤‘ìš”**

    * DB ì—°ê²° ì„¤ì •
    * `Base.metadata` ì§€ì •
  * `versions/`
    â†’ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ë“¤ì´ ìŒ“ì´ëŠ” ë””ë ‰í† ë¦¬

---

## revisionì´ë€?

> **revision = í•˜ë‚˜ì˜ DB êµ¬ì¡° ë³€ê²½ ê¸°ë¡ íŒŒì¼**

```bash
alembic revision --autogenerate -m "create theme_universe"
```

### ë‚´ë¶€ ë™ì‘ ìˆœì„œ

1. í˜„ì¬ DB êµ¬ì¡°ë¥¼ í™•ì¸í•œë‹¤
2. `Base.metadata`ì— ì •ì˜ëœ êµ¬ì¡°ë¥¼ í™•ì¸í•œë‹¤
3. ë‘ êµ¬ì¡°ì˜ **ì°¨ì´ì **ì„ ê³„ì‚°í•œë‹¤
4. ë³€ê²½ ë‚´ìš©ì„ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ë¡œ ìƒì„±í•œë‹¤

ê²°ê³¼:

```text
backend/db/migrations/versions/
â””â”€â”€ xxxx_create_theme_universe.py
```

âš ï¸ ì´ ì‹œì ì—ì„œëŠ” **DBëŠ” ì•„ì§ ë³€ê²½ë˜ì§€ ì•ŠëŠ”ë‹¤.**

---

## upgradeë€?

> **revision íŒŒì¼ì— ê¸°ë¡ëœ ë³€ê²½ ë‚´ìš©ì„
> ì‹¤ì œ DBì— ì ìš©í•˜ëŠ” í–‰ìœ„**

```bash
alembic upgrade head
```

* `head`ëŠ” ê°€ì¥ ìµœì‹  revisionì„ ì˜ë¯¸í•œë‹¤.

---

## revision vs upgrade ì •ë¦¬

* **revision**

  * DB êµ¬ì¡° ë³€ê²½ â€œê¸°ë¡ íŒŒì¼â€ì„ ìƒì„±
  * DBì—ëŠ” ì•„ì§ ë°˜ì˜ë˜ì§€ ì•ŠìŒ

* **upgrade**

  * revision íŒŒì¼ì˜ ë‚´ìš©ì„
  * ì‹¤ì œ DBì— ì ìš©

---

## ì™œ êµ³ì´ ë‚˜ëˆ´ëŠ”ê°€?

1. DB ë³€ê²½ ì´ë ¥ì„ ëª…í™•íˆ ê´€ë¦¬í•˜ê¸° ìœ„í•´
2. ì–¸ì œë“  ì´ì „ ìƒíƒœë¡œ ë˜ëŒë¦´ ìˆ˜ ìˆê²Œ í•˜ê¸° ìœ„í•´ (`downgrade`)
3. ë¡œì»¬ / ì„œë²„ / í´ë¼ìš°ë“œ í™˜ê²½ì„ ë™ì¼í•˜ê²Œ ë§ì¶”ê¸° ìœ„í•´

---

## Alembicì´ ë‚´ë¶€ì ìœ¼ë¡œ ë¹„êµí•˜ëŠ” ë‘ ì„¸ê³„

Alembicì€ í•­ìƒ ë‹¤ìŒ ë‘ ê°€ì§€ë¥¼ ë¹„êµí•œë‹¤.

### â‘  ë¡œì»¬ ì½”ë“œ ê¸°ì¤€

* `backend/db/migrations/versions/`
* ì´ í”„ë¡œì íŠ¸ì˜ **DB êµ¬ì¡° ë³€ê²½ ì—­ì‚¬**

### â‘¡ ì‹¤ì œ DB ê¸°ì¤€

* DB ë‚´ë¶€ì˜ `alembic_version` í…Œì´ë¸”
* í•´ë‹¹ DBê°€ **ì–´ë””ê¹Œì§€ì˜ revisionì„ ì ìš©í–ˆëŠ”ì§€** ê¸°ë¡

---

## ë°˜ë“œì‹œ ì§€ì¼œì•¼ í•  ì‘ì„± ìˆœì„œ

> **í•­ìƒ DBë¥¼ ìµœì‹  ìƒíƒœë¡œ ë§ì¶˜ ë’¤
> ìƒˆ revisionì„ ìƒì„±í•œë‹¤**

```bash
alembic upgrade head
alembic revision --autogenerate -m "..."
alembic upgrade head
```

ì´ ìˆœì„œë¥¼ ì–´ê¸°ë©´
revision ê¼¬ì„, head ì¶©ëŒ ê°™ì€ ë¬¸ì œê°€ ë°œìƒí•œë‹¤.


---

## ğŸ§¨ Alembic ë§ˆì´ê·¸ë ˆì´ì…˜ íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ê¸°ë¡

### ë°œìƒí•œ ë¬¸ì œ

ë‹¤ìŒê³¼ ê°™ì€ ì—ëŸ¬ê°€ ë°˜ë³µì ìœ¼ë¡œ ë°œìƒí–ˆë‹¤.

- `KeyError: ì´ì „_revision_id`
- `Target database is not up to date`
- `Revision referenced but not present`

---

## ì›ì¸ ìš”ì•½

- migration íŒŒì¼ì„ ì¼ë¶€ ìˆ˜ë™ ì‚­ì œ
- `down_revision`ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” revisionì„ ì°¸ì¡°
- DBì˜ `alembic_version`ê³¼
  ë¡œì»¬ `versions/` ë””ë ‰í† ë¦¬ ìƒíƒœ ë¶ˆì¼ì¹˜

ì¦‰,

> **Alembicì˜ â€œDB ì—­ì‚¬â€ì™€  
> â€œì½”ë“œ ì—­ì‚¬â€ê°€ ì„œë¡œ ë‹¬ë¼ì§„ ìƒíƒœ**

---

## í•µì‹¬ ê°œë… ì •ë¦¬

Alembicì€ í•­ìƒ ë‘ ì„¸ê³„ë¥¼ ë¹„êµí•œë‹¤.

1. ë¡œì»¬ ì½”ë“œ ìª½  
   - `backend/db/migrations/versions/`
2. ì‹¤ì œ DB ìª½  
   - `alembic_version` í…Œì´ë¸”

ì´ ë‘˜ì´ ì–´ê¸‹ë‚˜ë©´
â†’ migration ì‹œìŠ¤í…œì´ ê¹¨ì§„ë‹¤.

---

## í•´ê²° ë°©ì‹

1. ì˜ëª» ìƒì„±ëœ revision íŒŒì¼ ì œê±°
2. `versions/__pycache__` ì‚­ì œ
3. í˜„ì¬ ì •ìƒ head ê¸°ì¤€ìœ¼ë¡œ ë‹¤ì‹œ revision ìƒì„±
4. `alembic upgrade head`ë¡œ DB ì •í•©ì„± íšŒë³µ

---

## ì–»ì€ êµí›ˆ

- migration íŒŒì¼ì€ **ì ˆëŒ€ ê°€ë³ê²Œ ì‚­ì œí•˜ì§€ ë§ ê²ƒ**
- í•­ìƒ ì´ ìˆœì„œë¥¼ ì§€í‚¬ ê²ƒ

```bash
alembic upgrade head
alembic revision --autogenerate -m "..."
alembic upgrade head